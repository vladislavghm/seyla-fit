#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash deploy.sh

set -e

PROJECT_DIR="$HOME/seyla-fit"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${YELLOW}üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...${NC}"

cd "$PROJECT_DIR" || exit 1

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${YELLOW}üì• –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git...${NC}"
git pull origin main || git pull origin master

# –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å –∏ –º–µ—Å—Ç–æ)
echo -e "${YELLOW}üßπ –û—á–∏—â–∞–µ–º –∫–µ—à–∏ –∏ —Å—Ç–∞—Ä—ã–µ —Å–±–æ—Ä–∫–∏...${NC}"
rm -rf .next
rm -rf node_modules/.cache
rm -rf tina/__generated__/.cache
pnpm store prune 2>/dev/null || true

# –û—á–∏—â–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–µ—à–∏ (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç RAM)
echo -e "${YELLOW}   –û—á–∏—â–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–µ—à–∏...${NC}"
sync
echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null 2>&1 || true
echo -e "${GREEN}   ‚úì –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞${NC}"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
pnpm install --frozen-lockfile

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f .env.production ]; then
    set -a
    source .env.production
    set +a
    echo -e "${GREEN}   ‚úì –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã${NC}"
else
    echo -e "${YELLOW}   ‚ö†Ô∏è  –§–∞–π–ª .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å)
echo -e "${YELLOW}‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏...${NC}"
pm2 stop all 2>/dev/null || true
pm2 delete all 2>/dev/null || true
# –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js (–∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞)
pkill -9 -f "node.*next" 2>/dev/null || true
pkill -9 -f "tinacms" 2>/dev/null || true
pkill -9 -f "next-server" 2>/dev/null || true
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–∞–º—è—Ç—å
echo -e "${YELLOW}üìä –ü—Ä–æ—Ü–µ—Å—Å—ã Node.js:${NC}"
ps aux | grep -E "node|next|tinacms" | grep -v grep || echo "   –ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js"
echo -e "${YELLOW}üìä –î–æ—Å—Ç—É–ø–Ω–∞—è –ø–∞–º—è—Ç—å:${NC}"
free -h
echo -e "${YELLOW}üìä –¢–æ–ø –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–æ –ø–∞–º—è—Ç–∏:${NC}"
ps aux --sort=-%mem | head -10

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo -e "${YELLOW}üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç...${NC}"
export NODE_OPTIONS="--max-old-space-size=768"  # –£–º–µ–Ω—å—à–∞–µ–º –ª–∏–º–∏—Ç, —á—Ç–æ–±—ã –Ω–µ –ø—ã—Ç–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ —á–µ–º –µ—Å—Ç—å

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º TinaCMS —Ñ–∞–π–ª—ã —Å Tina Cloud API (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
# –ù–û: –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –µ—Å—Ç—å - –Ω–µ —Ç—Ä–∞—Ç–∏–º –ø–∞–º—è—Ç—å –∑—Ä—è
if [ ! -d "tina/__generated__" ] || [ ! -f "tina/__generated__/client.ts" ]; then
    echo -e "${YELLOW}   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º TinaCMS —Ñ–∞–π–ª—ã...${NC}"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook-server –≤—Ä–µ–º–µ–Ω–Ω–æ (–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ—Ä—Ç 9000, –Ω—É–∂–Ω—ã–π TinaCMS)
    echo -e "${YELLOW}   –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º webhook-server (–æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 9000)...${NC}"
    pm2 stop webhook-server 2>/dev/null || true
    
    # –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 9000, –µ—Å–ª–∏ –µ—Å—Ç—å
    lsof -ti:9000 | xargs kill -9 2>/dev/null || true
    sleep 2
    
    if [ -n "$NEXT_PUBLIC_TINA_CLIENT_ID" ] && [ -n "$TINA_TOKEN" ]; then
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Tina Cloud API (–∫–∞–∫ –Ω–∞ Vercel)
        echo -e "${GREEN}   –ò—Å–ø–æ–ª—å–∑—É–µ–º Tina Cloud API...${NC}"
        rm -rf tina/__generated__
        # –Ø–≤–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å –º–µ–Ω—å—à–∏–º –ª–∏–º–∏—Ç–æ–º –ø–∞–º—è—Ç–∏
        NODE_OPTIONS="--max-old-space-size=512" \
        NEXT_PUBLIC_TINA_CLIENT_ID="$NEXT_PUBLIC_TINA_CLIENT_ID" \
        TINA_TOKEN="$TINA_TOKEN" \
        NEXT_PUBLIC_TINA_BRANCH="${NEXT_PUBLIC_TINA_BRANCH:-main}" \
        timeout 300 pnpm tinacms build 2>&1 || {
            echo -e "${YELLOW}   ‚ö†Ô∏è  TinaCMS Cloud –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å –∏–∑-–∑–∞ –ø–∞–º—è—Ç–∏${NC}"
            echo -e "${YELLOW}   –ü—Ä–æ–ø—É—Å–∫–∞–µ–º - –∫–ª–∏–µ–Ω—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∏–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ TinaCMS${NC}"
        }
    else
        # –õ–æ–∫–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–∫–∏) - –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–∑-–∑–∞ –ø–∞–º—è—Ç–∏
        echo -e "${YELLOW}   –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Tina Cloud –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (—Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏)${NC}"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è)
if [ ! -f "tina/__generated__/client.ts" ]; then
    echo -e "${RED}   ‚ö†Ô∏è  TinaCMS –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    echo -e "${YELLOW}   –°—Ç—Ä–∞–Ω–∏—Ü—ã –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –º–æ–≥—É—Ç –ø–∞–¥–∞—Ç—å —Å –æ—à–∏–±–∫–∞–º–∏ TinaCMS${NC}"
    echo -e "${YELLOW}   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ç–æ–≤—É—é —Å–±–æ—Ä–∫—É —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–æ–π –∫–ª–∏–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
if [ -f "tina/__generated__/client.ts" ]; then
    if grep -q "localhost:4001" tina/__generated__/client.ts; then
        echo -e "${YELLOW}   ‚ö†Ô∏è  –ö–ª–∏–µ–Ω—Ç –≤—Å–µ –µ—â–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç localhost:4001${NC}"
        echo -e "${YELLOW}   –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Tina Cloud –µ—Å—Ç—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é${NC}"
    else
        echo -e "${GREEN}   ‚úì –ö–ª–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Tina Cloud API${NC}"
    fi
fi

# –°–æ–±–∏—Ä–∞–µ–º Next.js (—Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç–µ–ø–µ—Ä—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ, –Ω–µ —Ç—Ä–µ–±—É—é—Ç TinaCMS –ø—Ä–∏ —Å–±–æ—Ä–∫–µ)
echo -e "${YELLOW}   –°–æ–±–∏—Ä–∞–µ–º Next.js...${NC}"
# –°—Ç–∞—Ä–∞—è —Å–±–æ—Ä–∫–∞ —É–∂–µ —É–¥–∞–ª–µ–Ω–∞ –≤—ã—à–µ
# –° 3GB RAM –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–±–æ—Ä–∫–∏
export NODE_OPTIONS="--max-old-space-size=1536"
# –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 2 –≤–æ—Ä–∫–µ—Ä–∞ (–Ω–æ —Å 3GB –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å 1 –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
export NEXT_PRIVATE_WORKERS=1
export NODE_ENV=production
# –û—Ç–∫–ª—é—á–∞–µ–º source maps –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å)
export GENERATE_SOURCEMAP=false

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É
echo -e "${YELLOW}   üì¶ –õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏: 1536MB, —Å–±–æ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–π—Ç–∏ —É—Å–ø–µ—à–Ω–æ${NC}"

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É
pnpm next build --no-lint 2>&1 || {
    echo -e "${RED}   ‚ùå –°–±–æ—Ä–∫–∞ Next.js –Ω–µ —É–¥–∞–ª–∞—Å—å${NC}"
    echo -e "${YELLOW}   –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏...${NC}"
    free -h
    echo ""
    echo -e "${YELLOW}   üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã Node.js...${NC}"
    ps aux | grep -E "node|next" | grep -v grep || echo "   –ù–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js"
    exit 1
}

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
pm2 delete seyla-fit 2>/dev/null || true
pm2 delete webhook-server 2>/dev/null || true
# –ó–∞–ø—É—Å–∫–∞–µ–º webhook-server —Å–Ω–æ–≤–∞ (–æ–Ω –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è TinaCMS –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
pm2 start ecosystem.config.js --update-env --only webhook-server 2>/dev/null || true

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f .env.production ]; then
    set -a
    source .env.production
    set +a
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ ecosystem.config.js (–æ–Ω —Å–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
pm2 start ecosystem.config.js --update-env
pm2 save

echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
echo ""
pm2 status

