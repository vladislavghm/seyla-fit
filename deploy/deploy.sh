#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash deploy.sh

set -e

PROJECT_DIR="$HOME/seyla-fit"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${YELLOW}üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...${NC}"

cd "$PROJECT_DIR" || exit 1

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "${YELLOW}üì• –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git...${NC}"
git pull origin main || git pull origin master

# –û—á–∏—â–∞–µ–º –∫–µ—à–∏ (–Ω–æ –ù–ï —É–¥–∞–ª—è–µ–º .next - –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å)
echo -e "${YELLOW}üßπ –û—á–∏—â–∞–µ–º –∫–µ—à–∏...${NC}"
rm -rf node_modules/.cache
rm -rf tina/__generated__/.cache
pnpm store prune 2>/dev/null || true
echo -e "${GREEN}   ‚úì –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–µ–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞${NC}"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
pnpm install --frozen-lockfile

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -f .env.production ]; then
    set -a
    source .env.production
    set +a
    echo -e "${GREEN}   ‚úì –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã${NC}"
fi

# –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ - –æ–Ω–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏
# –°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ–∫–∞ –º—ã —Å–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é
echo -e "${YELLOW}üì¶ –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é (—Å—Ç–∞—Ä–∞—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)...${NC}"

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º TinaCMS —Ñ–∞–π–ª—ã (–∫–ª–∏–µ–Ω—Ç –∏ –∞–¥–º–∏–Ω–∫–∞)
# –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∞–¥–º–∏–Ω–∫—É –ø—Ä–∏ –¥–µ–ø–ª–æ–µ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏
if [ -n "$NEXT_PUBLIC_TINA_CLIENT_ID" ] && [ -n "$TINA_TOKEN" ]; then
    echo -e "${YELLOW}   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º TinaCMS —Ñ–∞–π–ª—ã (–∫–ª–∏–µ–Ω—Ç –∏ –∞–¥–º–∏–Ω–∫–∞)...${NC}"
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º Tina Cloud API (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –∫–ª–∏–µ–Ω—Ç, –∏ –∞–¥–º–∏–Ω–∫—É)
    rm -rf tina/__generated__
    rm -rf public/admin
    NODE_OPTIONS="--max-old-space-size=1024" \
    NEXT_PUBLIC_TINA_CLIENT_ID="$NEXT_PUBLIC_TINA_CLIENT_ID" \
    TINA_TOKEN="$TINA_TOKEN" \
    NEXT_PUBLIC_TINA_BRANCH="${NEXT_PUBLIC_TINA_BRANCH:-main}" \
    pnpm tinacms build 2>&1 || echo -e "${YELLOW}   ‚ö†Ô∏è  TinaCMS –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞${NC}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∞–¥–º–∏–Ω–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞
    if [ -d "public/admin" ]; then
        echo -e "${GREEN}   ‚úì –ê–¥–º–∏–Ω–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞${NC}"
    else
        echo -e "${YELLOW}   ‚ö†Ô∏è  –ê–¥–º–∏–Ω–∫–∞ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞${NC}"
    fi
else
    echo -e "${YELLOW}   ‚ö†Ô∏è  –ü—Ä–æ–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ TinaCMS (–Ω–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è)${NC}"
fi

# –°–æ–±–∏—Ä–∞–µ–º Next.js (—Å—Ç–∞—Ä–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)
echo -e "${YELLOW}üî® –°–æ–±–∏—Ä–∞–µ–º Next.js...${NC}"
export NODE_OPTIONS="--max-old-space-size=1536"
export NEXT_PRIVATE_WORKERS=1
export NODE_ENV=production
export GENERATE_SOURCEMAP=false

# –£–¥–∞–ª—è–µ–º .next —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ (–∫–∞–∫ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
if ! pm2 list | grep -q "seyla-fit.*online"; then
    echo -e "${YELLOW}   –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ, –æ—á–∏—â–∞–µ–º .next...${NC}"
    rm -rf .next
fi

if ! pnpm next build --no-lint; then
    echo -e "${RED}   ‚ùå –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å${NC}"
    # –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—ã–ª–æ –∑–∞–ø—É—â–µ–Ω–æ, –æ–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–µ–π
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo -e "${YELLOW}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è PM2
if [ -f .env.production ]; then
    set -a
    source .env.production
    set +a
fi

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –Ω—É–ª–µ–≤—ã–º –ø—Ä–æ—Å—Ç–æ–µ–º (graceful reload)
if pm2 list | grep -q "seyla-fit.*online"; then
    echo -e "${YELLOW}   –í—ã–ø–æ–ª–Ω—è–µ–º graceful reload (zero-downtime)...${NC}"
    pm2 reload seyla-fit --update-env
    # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ graceful reload –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    sleep 2
    if pm2 list | grep -q "seyla-fit.*online"; then
        echo -e "${GREEN}   ‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–æ${NC}"
    else
        echo -e "${RED}   ‚ö†Ô∏è  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å –ø–æ—Å–ª–µ reload, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏${NC}"
        pm2 logs seyla-fit --lines 20 --err
    fi
elif pm2 list | grep -q "seyla-fit"; then
    # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –µ—Å—Ç—å, –Ω–æ –Ω–µ –∑–∞–ø—É—â–µ–Ω - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
    echo -e "${YELLOW}   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø—Ä–æ—Ü–µ—Å—Å –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)...${NC}"
    pm2 restart seyla-fit --update-env
else
    # –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–µ—Ç - –∑–∞–ø—É—Å–∫–∞–µ–º
    echo -e "${YELLOW}   –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ...${NC}"
    cd "$PROJECT_DIR"
    pm2 start ecosystem.config.js --only seyla-fit --update-env
fi
pm2 save

echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
pm2 status
